/*
 * This source file was generated by the Gradle 'init' task
 */
package cse311;

import java.io.IOException;
import java.io.PrintStream;

public class App {
    public String getGreeting() {
        return "Hello World!";
    }

    public static void main(String[] args) {
        // Create a computer with 128MB of memory
        RV32iComputer computer = new RV32iComputer(128 * 1024 * 1024);
        RV32iCpu cpu = computer.getCpu();
        MemoryManager memoryManager = computer.getMemoryManager();
        ElfLoader elfLoader = new ElfLoader(memoryManager);

        try {
            // Load ELF file
            args = new String[] { "app/build/resources/main/hello_os.elf" };
            if (args.length > 0) {
                elfLoader.loadElf(args[0]);
                int entryPoint = elfLoader.getEntryPoint();

                PrintStream output = new PrintStream(System.out, false);
                output.println("Entry Point: " + entryPoint);
                // Print memory map for debugging
                output.println(memoryManager.getMemoryMap());
                output.flush();

                // Create a task for the main program
                int mainTaskId = computer.createTask(entryPoint);
                output.println("Created main task with ID: " + mainTaskId);

                // Start the CPU
                cpu.setProgramCounterEntryPoint(entryPoint);
                cpu.turnOn();

                // The program will run and use syscalls for I/O and task management
                // - Syscall 64 (write) for console output
                // - Syscall 63 (read) for console input
                // - Syscall 24 (yield) for cooperative multitasking
                // - Syscall 93 (exit) to terminate
            } else {
                System.err.println("Error: No ELF file specified. Please provide an ELF file path as an argument.");
            }
        } catch (Exception e) {
            System.err.println("Error running program: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
